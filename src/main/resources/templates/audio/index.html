<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>音乐随意听</title>
<link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<link th:href="@{/css/main.css}" rel="stylesheet">
<script type="text/javascript" th:src="@{/js/census.js}"></script>
<style type="text/css">
.nav {
	width: 100%;
	height: 55px;
	background: #e60012;
	line-height: 55px;
}

.nav .w1000 {
	line-height: 55px;
	position: relative;
	margin: 0 auto;
	text-align: center;
}

.nav .w1000 .span {
	display: inline-block;
}

.nav .w1000 a {
	color: #fff;
	margin: 0 5px 0 5px;
	font-size: 14px;
	font-family: 'SimSun';
}

.nav .w1000 .active {
	color: #000;
}

.audio_control .audio_player .fa {
	width: 20px;
}

[v-cloak] {
	display: none;
}
</style>
</head>
<body>
	<div v-cloak id="app">
		<div class="nav">
			<div class="w1000">
				<span v-for="menu in menus"><a href="javascript:void(0)" @click="requestData(menu.id)" v-bind:class="{'active':menu.id == code || !code && menu.id == '57'}">{{menu.name}}</a></span>
			</div>
		</div>
		<div class="audio_control">
			<audio class="J-audio">
				本页面采用HTML5编辑，目前您的浏览器无法显示，请换成谷歌(
				<a href="https://www.google.com/chrome/">Chrome</a>
				)浏览器，或者其他游览器的最新版本。
			</audio>
			<span class="audio_head">{{props.title}}</span> <span class="audio_player"> <a v-if="prev" href="javascript:void(0)" @click="requestData(code,prev)">
					<i class="fa fa-backward"></i>
				</a> <a href="javascript:void(0)" id="play" onclick="fnPlay(this)">
					<i class="fa fa-play"></i>
				</a> <a href="javascript:void(0)" class="c-hide" id="pause" onclick="fnPause(this)">
					<i class="fa fa-pause"></i>
				</a> <a v-if="next" href="javascript:void(0)" @click="requestData(code,next)">
					<i class="fa fa-forward"></i>
				</a>
			</span> <span class="audio_time J-audio-time"> <i> <span id="minute">00</span>:<span id="second">00</span>
			</i> / <span>{{props.audioPlayTime}}</span>
			</span>
		</div>
		<div class="article-container share-container wrapper-position">
			<div class="article" v-html="props.content"></div>
		</div>
	</div>
</body>
<script src="https://cdn.bootcss.com/jquery/3.4.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<script type="text/javascript">
	var audio = $('.J-audio')[0], minute, second, vMinute = 0, vSecond = 0, interval;
	var vm;
	$(document).ready(function() {
		vm = new Vue({
			el : '#app',
			data : {
				menus : [],
				code : '',
				prev : '',
				next : '',
				props : {}
			},
			created : function() {
				requestMenus();
				requestData();
			},
			mounted : function() {
			}
		});
	});

	function requestMenus() {
		$.post('[[@{/audio/menus}]]', {}, function(result) {
			vm.menus = result.data;
		});
	}

	function requestData(code, id) {
		$('#minute').text('00');
		$('#second').text('00');
		if (code) {
			vm.code = code;
		}
		$.post('[[@{/audio/daily}]]', {
			code : code,
			encodeId : id
		}, function(result) {
			vm.props = result.data.current;
			init();
			vm.prev = result.data.prevId;
			vm.next = result.data.nextId;
			var time = result.data.current.audioPlayTime.split(":");
			minute = parseInt(time[0]);
			second = parseInt(time[1]);
		});
	}

	function fnPlay(e) {
		interval = window.setInterval("fnRefreshAudioTime()", 1000);
		audio.play();
		$(e).addClass('c-hide');
		$(e).next().removeClass('c-hide');
	}
	function fnPause(e) {
		window.clearInterval(interval);
		audio.pause();
		$(e).addClass('c-hide');
		$(e).prev().removeClass('c-hide');
	}
	function fnRefreshAudioTime() {
		if (vMinute == minute && vSecond == second) {
			fnPause();
			vMinute = 0;
			vSecond = 0;
		} else {
			if (vSecond < 60) {
				vSecond++;
			} else if (vSecond >= 60) {
				vMinute++;
				vSecond = 0;
			}
		}
		fnDrawTime(vMinute, vSecond);
	}
	function fnDrawTime(m, s) {
		$('#minute').text(m < 10 ? '0' + m : m);
		$('#second').text(s < 10 ? '0' + s : s);
	}

	function init() {
		vMinute = 0;
		vSecond = 0;
		if (interval) {
			window.clearInterval(interval);
		}
		if (vm.props) {
			var source = '<source src="'+vm.props.audioUrl+'">';
			$(audio).empty();
			$(audio).prepend(source);
			$('#play').removeClass('c-hide');
			$('#pause').addClass('c-hide');
			audio.load();
		}
	}
</script>
</html>
